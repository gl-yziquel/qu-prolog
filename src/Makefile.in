export QP_LIBRARIES = \
	heap \
	ipc \
	library \
	psi \
	thread \
	template

export BIG_LIBRARY=qp.a
export LIBRARIES=$(addsuffix .a,$(QP_LIBRARIES))
export ALL_LIBRARIES=$(addprefix all.,$(QP_LIBRARIES))

export QP_COMMANDS = \
	qa \
	qdeal \
	qem \
	ql \
	@TK_ICM@

export ALL_COMMANDS=$(addprefix all.,$(QP_COMMANDS))

export TARGETS = $(QP_LIBRARIES) $(QP_COMMANDS)

export INSTALL = $(addprefix install.,$(TARGETS))

export DEPEND_TARGETS = $(QP_LIBRARIES) $(QP_COMMANDS)
export DEPEND = $(addprefix depend.,$(DEPEND_TARGETS))
export GENERATED = $(addprefix GENERATED.,$(DEPEND_TARGETS))

# Optimisation level of compilation
export OPTIMISATION=-O3

# Debugging options:
#	DEBUG		: General debugging of system
#	DEBUG_SCHED	: Debugging information about scheduler
#	DEBUG_BLOCK	: Debugging information about blocking behaviour
#	DEBUG_IO	: Debugging information about IO behaviour
#	DEBUG_ICM	: Debugging information about ICM interface
#	DEBUG_TIMEOUT	: Debugging information about timeouts
#	DEBUG_RETRY	: Debugging information about retries
#	DEBUG_MT	: Debugging information about multi-threading

export DEBUGGING=

export CXXFLAGS = -Wall -D_GNU_SOURCE=1 $(OPTIMISATION) $(DEBUGGING) -I@ICMHOME@/include @GCCINCLUDES@ -Wno-uninitialized
export QACXXFLAGS = -Wall -D_GNU_SOURCE=1 $(DEBUGGING) -I@ICMHOME@/include @GCCINCLUDES@ -Wno-uninitialized

.PHONY: all
all: commands

# Libraries
include Makefile.heap
include Makefile.ipc
include Makefile.library
include Makefile.psi
include Makefile.template
include Makefile.thread

export LIBRARY_OBJECTS = \
	$(OBJECTS.heap) \
	$(OBJECTS.ipc) \
	$(OBJECTS.library) \
	$(OBJECTS.psi) \
	$(OBJECTS.template) \
	$(OBJECTS.thread)

# Commands
include Makefile.qa
include Makefile.qdeal
include Makefile.qem
include Makefile.ql
include Makefile.tkICM

export GENERATED = \
	$(GENERATED.heap) \
	$(GENERATED.ipc) \
	$(GENERATED.library) \
	$(GENERATED.psi) \
	$(GENERATED.template) \
	$(GENERATED.thread) \
	$(GENERATED.qa) \
	$(GENERATED.qdeal) \
	$(GENERATED.qem) \
	$(GENERATED.ql)

# Targets

.PHONY: commands
commands: $(GENERATED) $(LIBRARIES) $(BIG_LIBRARY)
	@$(MAKE) $(ALL_COMMANDS)

$(BIG_LIBRARY): $(LIBRARY_OBJECTS)
	$(AR) $(ARFLAGS) $@ $(LIBRARY_OBJECTS)
	@RANLIB@ $@

.PHONY: install
install: $(INSTALL)


